<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CCS Triggers Validation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-30">
    <div class="flex items-center space-x-3">
      <img src="datascout_logo.png" alt="DataScout Logo" class="h-12 w-12">
      <h1 class="text-2xl font-bold">CCS Triggers Validation Dashboard</h1>
    </div>
    <div class="flex space-x-2">
      <input type="text" id="search-member" placeholder="üîç Search Member ID"
             class="border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200">
      <select class="border rounded px-3 py-2 text-sm focus:ring focus:ring-blue-200" id="filter-action">
        <option value="">All Action Codes</option>
      </select>
      <input type="text" id="start-date" class="border rounded px-2 py-1 text-sm" placeholder="Start Date">
      <input type="text" id="end-date" class="border rounded px-2 py-1 text-sm" placeholder="End Date">
      <select id="quick-filter" class="border rounded px-2 py-1 text-sm">
        <option value="">Quick Filters</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="month">This Month</option>
        <option value="year">This Year</option>
        <option value="all">All Time</option>
      </select>
    </div>
  </header>

  <!-- Layout -->
  <div class="flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-white p-4 border-r space-y-4 min-h-screen">
  <nav class="space-y-3">
    <a href="analytics.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition">
       <span>Human Analytics</span>
    </a>
    <a href="triggers_analytics.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition">
       <span>AI Analytics</span>
    </a>
    <a href="https://engage.app.datascout.ai/ccs/prompts" target="_blank" 
       class="flex items-center space-x-2 text-gray-700 hover:text-blue-600 transition">
       <span>Engage</span>
    </a>
  </nav>
</aside>

    <!-- Main -->
    <main class="flex-1 p-6 space-y-6">
      <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="overflow-y-auto max-h-[80vh]">
          <table class="min-w-full text-sm text-left border-collapse">
            <thead class="bg-gray-200 sticky top-0 z-20 shadow-sm">
              <tr>
                <th class="px-6 py-3 font-semibold text-gray-700">Member ID</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Name</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Action Reason</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Action Code</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Created At</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Match?</th>
                <th class="px-6 py-3 font-semibold text-gray-700">Notes</th>
              </tr>
            </thead>
            <tbody id="data-table-body" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl w-full">
      <h2 class="text-lg font-bold mb-2">Details</h2>
      <p id="modal-text" class="whitespace-pre-wrap"></p>
      <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Close</button>
    </div>
  </div>

  <!-- Script -->
  <script>
    let allData = [];
    let filteredData = [];

    async function loadData() {
      const res = await fetch("data.json");
      allData = await res.json();
      filteredData = [...allData];
      renderTable(filteredData);
      populateActionFilter(allData);
    }


    function renderTable(data) {
      const tbody = document.querySelector("#data-table-body");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No results found</td></tr>`;
        return;
      }

      data.forEach((row, rowIndex) => {
        tbody.innerHTML += `
          <tr class="hover:bg-blue-50 transition">
            <td class="px-6 py-3">
              <a href="https://my.ccs.ca/CCSStaff/Account_Page_Staff.aspx?ID=${row.member_id}&WebsiteKey=4243d9e2-e91e-468c-97c2-2046d70c1e1a"
                 target="_blank" class="text-blue-600 hover:underline">
                ${row.member_id}
              </a>
            </td>
            <td class="px-6 py-3 editable" data-field="name" data-index="${rowIndex}">
              ${row.first_name} ${row.last_name}
            </td>
            <td class="px-6 py-3 editable truncate max-w-xs cursor-pointer text-teal-600 underline hover:text-teal-800"
                data-field="action_reason" data-index="${rowIndex}" data-modal="${row.action_reason}">
              ${row.action_reason.length > 60 ? row.action_reason.substring(0, 60) + "..." : row.action_reason}
            </td>
            <td class="px-6 py-3 editable" data-field="action_code" data-index="${rowIndex}">
              ${row.action_code}
            </td>
            <td class="px-6 py-3">${row.created_at}</td>
            <td class="px-6 py-3 editable-boolean" data-field="match_result" data-index="${rowIndex}">
              ${row.match_result ? "‚úÖ Match" : "‚ùå No Match"}
            </td>
            <td class="px-6 py-3 editable truncate max-w-xs cursor-pointer underline text-gray-700 hover:text-gray-900"
                data-field="notes" data-index="${rowIndex}" data-modal="${row.notes}">
              ${row.notes.length > 50 ? row.notes.substring(0, 50) + "..." : row.notes}
            </td>
          </tr>
        `;
      });

      attachEditing();
    }

    function attachEditing() {
      // Modal open on single click
      document.querySelectorAll("[data-modal]").forEach(cell => {
        cell.addEventListener("click", e => {
          if (e.detail === 1) {
            openModal(cell.dataset.modal);
          }
        });
      });

      // Inline editing on double click
      document.querySelectorAll(".editable").forEach(cell => {
        cell.addEventListener("dblclick", () => {
          const field = cell.dataset.field;
          const index = cell.dataset.index;
          let oldValue = cell.innerText.trim();
          const input = document.createElement("input");
          input.type = "text";
          input.value = oldValue;
          input.className = "border px-2 py-1 w-full text-sm";

          input.addEventListener("blur", () => {
            let newValue = input.value;
            cell.innerText = newValue.length > 60 ? newValue.substring(0, 60) + "..." : newValue;
            cell.title = newValue;

            if (field === "name") {
              const [firstName, ...rest] = newValue.split(" ");
              allData[index].first_name = firstName;
              allData[index].last_name = rest.join(" ");
            } else {
              allData[index][field] = newValue;
            }
            saveRecord(allData[index]);
          });

          cell.innerHTML = "";
          cell.appendChild(input);
          input.focus();
        });
      });

      // Boolean editing
      document.querySelectorAll(".editable-boolean").forEach(cell => {
        cell.addEventListener("click", () => {
          const field = cell.dataset.field;
          const index = cell.dataset.index;
          const oldValue = allData[index][field];
          if (cell.querySelector("select")) return;

          const select = document.createElement("select");
          select.className = "border rounded px-2 py-1 text-sm bg-white";
          select.innerHTML = `
            <option value="true" ${oldValue ? "selected" : ""}>‚úÖ Match</option>
            <option value="false" ${!oldValue ? "selected" : ""}>‚ùå No Match</option>
          `;
          select.addEventListener("change", () => {
            const newVal = select.value === "true";
            allData[index][field] = newVal;
            cell.innerText = newVal ? "‚úÖ Match" : "‚ùå No Match";
            saveRecord(allData[index]);
          });
          select.addEventListener("blur", () => {
            const newVal = select.value === "true";
            cell.innerText = newVal ? "‚úÖ Match" : "‚ùå No Match";
          });
          cell.innerHTML = "";
          cell.appendChild(select);
          select.focus();
        });
      });
    }

    function openModal(text) {
      document.getElementById("modal-text").innerText = text;
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("modal").classList.add("flex");
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal").classList.remove("flex");
    }

    // Filters
    function applyFilters() {
      let data = [...allData];
      const searchTerm = document.getElementById("search-member").value.trim();
      const actionFilter = document.getElementById("filter-action").value;
      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;

      if (searchTerm) {
        data = data.filter(r => r.member_id.includes(searchTerm));
      }
      if (actionFilter) {
        data = data.filter(r => r.action_code === actionFilter);
      }
      if (startDate) {
        data = data.filter(r => new Date(r.created_at) >= new Date(startDate));
      }
      if (endDate) {
        data = data.filter(r => new Date(r.created_at) <= new Date(endDate));
      }

      renderTable(data);
    }

    function populateActionFilter(data) {
      const select = document.getElementById("filter-action");
      select.innerHTML = `<option value="">All Action Codes</option>`;
      const codes = [...new Set(data.map(r => r.action_code))];
      codes.forEach(code => {
        const opt = document.createElement("option");
        opt.value = code;
        opt.textContent = code;
        select.appendChild(opt);
      });
      select.addEventListener("change", applyFilters);
    }

    // Quick filter logic
    document.getElementById("quick-filter").addEventListener("change", e => {
      const val = e.target.value;
      const now = new Date();
      let start = null;

      if (val === "7") start = new Date(now.setDate(now.getDate() - 7));
      if (val === "30") start = new Date(now.setDate(now.getDate() - 30));
      if (val === "month") start = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      if (val === "year") start = new Date(new Date().getFullYear(), 0, 1);

      if (val === "all" || val === "") {
        document.getElementById("start-date").value = "";
        document.getElementById("end-date").value = "";
      } else {
        document.getElementById("start-date")._flatpickr.setDate(start);
        document.getElementById("end-date")._flatpickr.setDate(new Date());
      }
      applyFilters();
    });

    // Search
    document.getElementById("search-member").addEventListener("input", applyFilters);

    // Flatpickr init
    flatpickr("#start-date", { dateFormat: "Y-m-d", onChange: applyFilters });
    flatpickr("#end-date", { dateFormat: "Y-m-d", onChange: applyFilters });

    loadData();
  </script>
</body>
</html>
